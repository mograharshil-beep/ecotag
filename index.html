<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Freshness Sticker Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#a6b0bf;
    --accent:#16a34a; --accent-2:#f59e0b; --danger:#ef4444;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg,#071026 0%, #042639 100%);
    color:#e6eef6;
    padding:20px;
  }
  .app {
    width:100%; max-width:820px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:18px; box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }
  header{display:flex; gap:16px; align-items:center;}
  .logo{
    width:100px; height:64px; border-radius:12px; background:linear-gradient(135deg,var(--accent), #059669);
    display:flex; align-items:center; justify-content:center; font-weight:700; color:white; font-size:22px;
    box-shadow: 0 6px 20px rgba(22,163,74,0.16);
  }
  h1{margin:0;font-size:20px}
  p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}
  .layout{display:grid; grid-template-columns: 1fr 360px; gap:18px; margin-top:18px;}
  .card{background:var(--card); border-radius:12px; padding:14px; border:1px solid var(--glass);}
  .left{min-height:360px; display:flex; flex-direction:column; gap:12px;}
  .upload-area{display:flex; gap:12px; align-items:center; justify-content:space-between}
  input[type=file]{display:none}
  .btn {
    background:linear-gradient(90deg,#10b981,#059669); color:white; padding:10px 14px; border-radius:10px; border:none;
    font-weight:600; cursor:pointer; box-shadow: 0 6px 18px rgba(5,150,105,0.12);
  }
  .btn.secondary{background: linear-gradient(90deg,#f97316,#f59e0b);}
  .preview{display:block;width:100%; height:260px; background:linear-gradient(180deg,#061426,#092535); border-radius:10px;
    display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px dashed rgba(255,255,255,0.03);}
  .preview img{max-width:100%; max-height:100%; object-fit:contain}
  .hint{font-size:13px;color:var(--muted)}
  .right{display:flex; flex-direction:column; gap:12px}
  .swatch{height:86px; border-radius:10px; display:flex; align-items:center; padding:10px; gap:12px; color:#04121b}
  .swatch .box{width:64px;height:64px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
  .result {font-size:18px; font-weight:700}
  .sub {color:var(--muted); font-size:13px}
  .meta{display:flex; gap:8px; margin-top:6px}
  .meta .chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03); font-size:13px; color:var(--muted)}
  footer{margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:space-between}
  .small{font-size:12px;color:var(--muted)}
  @media(max-width:900px){ .layout{grid-template-columns:1fr; } .right{order:2} }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">ecoTAG</div>
    <div>
      <h1>Smart Freshness Scanner</h1>
      <p class="lead">Upload/scan your sticker ‚Äî Freshness at a Glance.</p>
    </div>
  </header>

  <div class="layout">
    <div class="card left">
      <div class="upload-area">
        <div style="display:flex;flex-direction:column;">
          <label for="fileInput" class="btn" title="Use camera on mobile"><span>üì∏ Scan / Upload</span></label>
          <input id="fileInput" type="file" accept="image/*" capture="environment">
          <div class="hint" style="margin-top:8px">Tip: align sticker near center, use daylight for best accuracy.</div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <button class="btn secondary" id="resetBtn" title="Clear image">Reset</button>
          <div class="hint" style="margin-top:8px">Works offline in your browser</div>
        </div>
      </div>

      <div class="preview" id="previewBox">
        <span style="color:var(--muted)">No image yet ‚Äî click Scan / Upload</span>
      </div>

      <div style="display:flex; gap:12px; margin-top:10px; align-items:center;">
        <button class="btn" id="analyzeBtn">üîç Analyze Sticker</button>
        <div style="flex:1"></div>
        <div class="hint">Average color & central crop used for reliable detection</div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <div class="meta">
          <div class="chip">Demo: Color-based readout</div>
          <div class="chip">No account required</div>
        </div>
      </div>
    </div>

    <div class="card right">
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div class="swatch" id="swatch" style="background:linear-gradient(90deg,#eef2ff,#fff5f0);">
          <div class="box" id="colorBox" style="background:#ffffff"></div>
          <div style="flex:1">
            <div class="result" id="resultText">No analysis yet</div>
            <div class="sub" id="subText">Upload a sticker image and press Analyze</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1">
            <div class="sub"></div>
            <div id="rgbText" style="font-weight:600"></div>
          </div>
          <div style="flex:1">
            <div class="sub"></div>
            <div id="guidanceText" style="font-weight:600; color:var(--muted)">‚Äî</div>
          </div>
        </div>

        <div style="margin-top:4px">
          <div class="sub">How to read</div>
          <div style="color:var(--muted); font-size:13px; margin-top:6px">
            <strong>Purple</strong> ‚Üí Fresh (4‚Äì5 days)<br>
            <strong>Red</strong> ‚Üí Use soon (2‚Äì3 days)<br>
            <strong>Yellow/Green</strong> ‚Üí Spoiled (0‚Äì1 day)
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="small">Made for demo ‚Ä¢ Works offline ‚Ä¢ Use daylight for best results</div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="sampleGreen">Sample: Green</button>
      <button class="btn" id="sampleYellow">Sample: Yellow</button>
      <button class="btn" id="sampleRed">Sample: Red</button>
    </div>
  </footer>
</div>

<!-- hidden canvas for analysis -->
<canvas id="canvas" style="display:none;"></canvas>

<script>
/* ---------- Helpers ---------- */
const fileInput = document.getElementById('fileInput');
const previewBox = document.getElementById('previewBox');
const analyzeBtn = document.getElementById('analyzeBtn');
const resetBtn = document.getElementById('resetBtn');
const colorBox = document.getElementById('colorBox');
const resultText = document.getElementById('resultText');
const subText = document.getElementById('subText');
const rgbText = document.getElementById('rgbText');
const guidanceText = document.getElementById('guidanceText');
const canvas = document.getElementById('canvas');
let currentImage = null;

// Accept file and preview
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  showPreview(url);
});

// Show preview helper
function showPreview(src) {
  previewBox.innerHTML = '';
  const img = new Image();
  img.src = src;
  img.onload = () => {
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    previewBox.appendChild(img);
    currentImage = img;
  };
  img.onerror = () => { previewBox.innerHTML = '<span style="color:#fca5a5">Could not load image</span>'; currentImage = null; }
}

// Reset
resetBtn.addEventListener('click', ()=> {
  fileInput.value = '';
  previewBox.innerHTML = '<span style="color:var(--muted)">No image yet ‚Äî click Scan / Upload</span>';
  colorBox.style.background = '#ffffff';
  resultText.textContent = 'No analysis yet';
  subText.textContent = 'Upload a sticker image and press Analyze';
  rgbText.textContent = '‚Äî';
  guidanceText.textContent = '‚Äî';
  currentImage = null;
});

// Core analysis routine
analyzeBtn.addEventListener('click', ()=>{
  if (!currentImage) { alert('Please upload/scan a sticker image first'); return; }
  analyzeImage(currentImage);
});

// Sample buttons for demo
document.getElementById('sampleGreen').addEventListener('click', ()=> fakeAnalyze({r:40,g:170,b:60}));
document.getElementById('sampleYellow').addEventListener('click', ()=> fakeAnalyze({r:220,g:190,b:40}));
document.getElementById('sampleRed').addEventListener('click', ()=> fakeAnalyze({r:200,g:40,b:35}));

function fakeAnalyze(avg){ // quick demo without file
  updateUI(avg);
}

// Draw image onto canvas and sample central circular region to reduce background noise
function analyzeImage(image) {
  const maxSide = 800;
  const w = image.naturalWidth;
  const h = image.naturalHeight;
  // scale for speed
  const scale = Math.min(1, maxSide / Math.max(w,h));
  const W = Math.round(w * scale);
  const H = Math.round(h * scale);
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(image, 0, 0, W, H);

  // central circle sampling
  const cx = Math.floor(W/2), cy = Math.floor(H/2);
  const radius = Math.floor(Math.min(W,H) * 0.22); // sample ~44% diameter central circle
  let rSum=0,gSum=0,bSum=0,count=0;

  const imgData = ctx.getImageData(0,0,W,H).data;
  // sample pixels in central circle with stride for speed
  const stride = 6; // adjust speed/quality
  for (let y = cy - radius; y <= cy + radius; y += stride) {
    for (let x = cx - radius; x <= cx + radius; x += stride) {
      const dx = x - cx, dy = y - cy;
      if (dx*dx + dy*dy <= radius*radius) {
        const idx = (y * W + x) * 4;
        // ensure we are inside bounds
        if (idx >= 0 && idx+2 < imgData.length) {
          const rr = imgData[idx], gg = imgData[idx+1], bb = imgData[idx+2];
          // ignore near-white/near-black background pixels
          if (!isBackground(rr,gg,bb)) {
            rSum += rr; gSum += gg; bSum += bb; count++;
          }
        }
      }
    }
  }

  if (count === 0) {
    subText.textContent = 'Could not detect sticker region. Try cropping photo so sticker is central.';
    guidanceText.textContent = 'No valid pixels';
    resultText.textContent = 'Try again';
    return;
  }

  const avg = { r: Math.round(rSum/count), g: Math.round(gSum/count), b: Math.round(bSum/count) };
  updateUI(avg);
}

// Background heuristics: ignore very bright or very dark pixels or near-gray background
function isBackground(r,g,b){
  // near-white or near-black or very gray
  const v = (r+g+b)/3;
  if (v < 10 || v > 245) return true;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  if ( (max - min) < 8 && v > 200 ) return true; // flat white-ish
  return false;
}

// Convert RGB to HSV
function rgbToHsv(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  const d = max - min;
  let h = 0;
  if (d === 0) h = 0;
  else if (max === r) h = 60 * (((g - b) / d) % 6);
  else if (max === g) h = 60 * (((b - r) / d) + 2);
  else h = 60 * (((r - g) / d) + 4);
  if (h < 0) h += 360;
  const s = max === 0 ? 0 : d / max;
  const v = max;
  return {h: Math.round(h), s: Number(s.toFixed(2)), v: Number(v.toFixed(2))};
}

// Update UI from average rgb
function updateUI(avg){
  const hex = rgbToHex(avg.r, avg.g, avg.b);
  colorBox.style.background = hex;
  rgbText.textContent = `R ${avg.r}  G ${avg.g}  B ${avg.b}  ‚Ä¢  ${hex}`;
  const hsv = rgbToHsv(avg.r, avg.g, avg.b);

  // lighting check
  if (hsv.v < 0.15) {
    resultText.textContent = 'Too dark ‚Äî retake in daylight';
    subText.textContent = 'Move to brighter light and try again';
    guidanceText.textContent = 'Low brightness';
    return;
  }

  let label = 'Uncertain';
  let days = '‚Äî';
  let colorClass = '#9ca3af';

  // Purple = Fresh
  if (hsv.h >= 260 && hsv.h <= 300 && hsv.s > 0.2 && hsv.v > 0.15) {
    label = 'Fresh';
    days = '4‚Äì5 days';
    colorClass = '#8b5cf6'; // purple
  }
  // Red = Use soon
  else if ((hsv.h < 20 || hsv.h > 340) && hsv.s > 0.2 && hsv.v > 0.15) {
    label = 'Almost Spoiled';
    days = '2‚Äì3 days';
    colorClass = '#ef4444'; // red
  }
  // Green/Yellow = Fully Spoiled
  else if (hsv.h >= 40 && hsv.h <= 160 && hsv.s > 0.18 && hsv.v > 0.15) {
    label = 'Fully Spoiled';
    days = '0‚Äì1 day';
    colorClass = '#22c55e'; // green/yellow
  }
  else {
    // fallback for odd/low saturation colors
    if (hsv.s < 0.12) {
      label = 'Faded';
      days = '0‚Äì1 day';
      colorClass = '#9ca3af';
    } else {
      label = 'Borderline';
      days = '1‚Äì2 days';
      colorClass = '#f97316';
    }
  }

  resultText.textContent = `${label} ‚Äî ${days}`;
  subText.textContent = `Hue ${hsv.h}¬∞, Sat ${Math.round(hsv.s*100)}%, Val ${Math.round(hsv.v*100)}%`;
  guidanceText.textContent = '';
}


// tiny util: rgb -> hex
function rgbToHex(r,g,b){
  return "#"+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}
</script>

</body>
</html>

